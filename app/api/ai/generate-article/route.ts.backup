import { NextRequest, NextResponse } from 'next/server';
import OpenAI from 'openai';
import { marked } from 'marked';
import axios from 'axios';

// Configuration OpenAI (avec fallback pour √©viter erreur build)
const openai = process.env.OPENAI_API_KEY ? new OpenAI({
  apiKey: process.env.OPENAI_API_KEY,
}) : null;

// Configuration Perplexity
const PERPLEXITY_API_KEY = process.env.PERPLEXITY_API_KEY || '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';

// SUJETS EVERGREEN - Bas√©s sur les VRAIS services Agenzys
const ARTICLE_TOPICS = [
  {
    title: "Automatisation n8n : Comment Capturer et Qualifier vos Leads Immobiliers",
    excerpt: "Gagnez 2-4h par semaine gr√¢ce √† l'automatisation intelligente de la capture et qualification de leads. Int√©gration compl√®te avec votre CRM existant.",
    category: "Automatisation Leads",
    keywords: ["capture leads automatique", "qualification IA", "n8n immobilier", "automatisation CRM", "leads qualifi√©s"],
    type: "evergreen"
  },
  {
    title: "Traitement Automatis√© des Dossiers de Location : OCR et Anti-Fraude IA",
    excerpt: "√âconomisez plusieurs jours par dossier gr√¢ce √† l'analyse IA des documents locataires et la d√©tection automatique de fraudes.",
    category: "Gestion Locative",
    keywords: ["OCR dossier location", "anti-fraude IA", "automatisation locative", "analyse documents", "n8n gestion"],
    type: "evergreen"
  },
  {
    title: "Synchronisation CRM-Portails : Publication d'Annonces Automatis√©e",
    excerpt: "Z√©ro erreur de publication ! Synchronisez automatiquement vos biens entre CRM et portails immobiliers (SeLoger, LeBonCoin).",
    category: "Publication Annonces",
    keywords: ["synchronisation CRM", "publication automatique", "portails immobiliers", "n8n annonces", "SeLoger automation"],
    type: "evergreen"
  },
  {
    title: "Relances Automatis√©es : R√©duisez de 45% vos Impay√©s de Loyer",
    excerpt: "Automatisez vos appels de loyers et relances pour r√©duire drastiquement les impay√©s et la vacance locative.",
    category: "Gestion Locative",
    keywords: ["relances automatis√©es", "impay√©s loyer", "gestion locative automatique", "n8n loyers", "recouvrement"],
    type: "evergreen"
  },
  {
    title: "Chatbot IA 24/7 : WhatsApp et Site Web pour Agences Immobili√®res",
    excerpt: "Disponibilit√© totale ! R√©pondez aux prospects 24h/24 via chatbot IA intelligent connect√© √† votre CRM.",
    category: "Relation Client",
    keywords: ["chatbot immobilier", "WhatsApp automation", "IA conversationnelle", "disponibilit√© 24/7", "prospect chatbot"],
    type: "evergreen"
  },
  {
    title: "Int√©gration n8n avec Hektor, Adapt Immo et Leizee : Guide Complet",
    excerpt: "Connectez vos outils existants sans les changer ! Guide d'int√©gration compl√®te avec les principaux logiciels immobiliers.",
    category: "Int√©grations",
    keywords: ["int√©gration Hektor", "Adapt Immo automation", "Leizee n8n", "CRM int√©gration", "outils immobiliers"],
    type: "evergreen"
  }
];

// SUJETS D'ACTUALIT√â IMMOBILI√àRE (Perplexity)
const NEWS_TOPICS = [
  {
    search: "actualit√© immobilier France 2025 nouveaux d√©crets lois",
    keywords: ["actualit√© immobilier", "loi immobili√®re 2025", "d√©cret immobilier"],
    category: "Actualit√©",
    type: "news"
  },
  {
    search: "march√© immobilier fran√ßais janvier 2025 prix √©volution tendances",
    keywords: ["march√© immobilier 2025", "prix immobilier France", "tendances immobili√®res"],
    category: "March√©",
    type: "news"
  },
  {
    search: "nouvelles technologies PropTech 2025 innovation immobilier digital",
    keywords: ["PropTech 2025", "innovation immobili√®re", "technologie immobilier"],
    category: "Innovation",
    type: "news"
  },
  {
    search: "cr√©dit immobilier taux int√©r√™t 2025 banques nouvelles conditions",
    keywords: ["taux immobilier 2025", "cr√©dit immobilier", "financement immobilier"],
    category: "Financement",
    type: "news"
  }
];

// PROMPT OPTIMIS√â SEO pour GPT-4 (version raccourcie)
const ARTICLE_PROMPT = `Expert SEO immobilier. R√©dige article blog sur : {topic}

CONTRAINTES :
- 2000-3000 mots 
- Structure H1 > H2 > H3
- Mots-cl√©s : {keywords} (1-2% densit√©)
- CTA Agenzys tous les 300 mots
- Liens cliquables vers Agenzys

STRUCTURE :
1. <h2>üìà Introduction</h2><p> (200 mots) - Hook statistique + probl√®me + solution Agenzys
2. **## Pourquoi {topic} crucial 2025** (400 mots) - Stats march√© + impact CA
3. **## 5 d√©fis agences immobili√®res** (500 mots) - D√©fis d√©taill√©s + exemples
4. **## Solutions Agenzys n8n & IA** (600 mots) - 5 automatisations principales + gains de temps mesur√©s + int√©grations CRM + ROI + CTA
5. **## Guide pratique √©tapes** (600 mots) - 8 √©tapes concr√®tes + timeline
6. **## Outils recommand√©s** (400 mots) - Stack tech + int√©grations
7. **## 7 erreurs √† √©viter** (400 mots) - Erreurs co√ªteuses + bonnes pratiques
8. **## Cas clients** (300 mots) - R√©sultats concrets + t√©moignages
9. **## Conclusion** (200 mots) - R√©cap + CTA fort

LIENS CLIQUABLES OBLIGATOIRES :
- [D√©couvrez Agenzys](https://agenzys.vercel.app)
- [Voir nos fonctionnalit√©s](https://agenzys.vercel.app/#features)
- [Demander une d√©mo](https://agenzys.vercel.app)
- [Lire nos articles](https://agenzys.vercel.app/blog)

STYLE : 
- Professionnel, vouvoiement
- Stats 2024-2025 r√©centes
- Exemples fran√ßais (Paris, Lyon, Marseille)
- Marques connues (SeLoger, LeBonCoin, Logic-Immo)
- Espacement entre paragraphes

AGENZYS SERVICES R√âELS (IMPORTANT) :
- Solutions d'automatisation via n8n et IA
- Suppression des t√¢ches manuelles chronophages
- Int√©gration avec CRM existants (Adapt Immo, Eudonet, Leizee, Pipedrive, Scoplan)
- Logiciels de transaction (Hektor, Netty, Modelo)
- Gestion locative (Ublo, Rentila, LockImmo)
- Email/SMS marketing (Mailchimp, Sendinblue)
- Signatures √©lectroniques (Yousign, ImmoSign, DocuSign)

5 AUTOMATISATIONS PRINCIPALES :
1. Capture & Qualification Leads (2-4h/sem gagn√©es)
2. Traitement Dossiers Location (plusieurs jours/dossier)
3. Publication & MAJ Annonces (z√©ro erreurs)
4. Relances & Gestion Locative (-45% impay√©s)
5. Chatbot IA 24/7 (WhatsApp, site web)

IMPORTANT :
- PAS de "Titre :" au d√©but
- Format HTML DIRECT (pas Markdown !)
- Structure: <h1>, <h2>, <h3> avec emojis
- Paragraphes: <p> bien espac√©s
- Listes: <ul><li> avec ic√¥nes emoji
- Liens: <a href="url" target="_blank" style="color: #3b82f6;">texte</a>
- CTA boutons: <a href="url" style="background: #3b82f6; color: white; padding: 12px 24px; text-decoration: none; border-radius: 6px;">CTA</a>
- NE PAS inventer de fonctionnalit√©s Agenzys !

EXEMPLE FORMAT HTML:
<h1>üéØ Titre Principal</h1>
<h2>üìà Section Important</h2>
<p>Texte avec <strong>gras</strong> et <a href="https://agenzys.vercel.app" target="_blank" style="color: #3b82f6;">lien styl√©</a>.</p>
<ul>
<li>üîß Point avec emoji</li>
<li>‚ö° Autre point</li>
</ul>
<p><a href="https://agenzys.vercel.app" target="_blank" style="background: #3b82f6; color: white; padding: 12px 24px; text-decoration: none; border-radius: 6px; display: inline-block;">üöÄ CTA Bouton</a></p>`;

// PROMPT DALL-E pour images
const IMAGE_PROMPT = `Professional real estate technology illustration for "{topic}". 
Modern office, technology devices, real estate symbols, clean design, 
blue and orange colors, no text, 16:9 ratio, professional lighting.`;

// FONCTION PERPLEXITY SONAR PRO - Recherche actualit√© immobili√®re
async function getLatestRealEstateNews(searchQuery: string) {
  try {
    console.log(`[PERPLEXITY] Recherche: "${searchQuery}"`);
    
    const response = await axios.post('https://api.perplexity.ai/chat/completions', {
      model: "llama-3.1-sonar-huge-128k-online",
      messages: [
        {
          role: "system",
          content: "Tu es un expert en actualit√© immobili√®re fran√ßaise. Recherche et r√©sume les informations les plus r√©centes et pertinentes sur le secteur immobilier fran√ßais."
        },
        {
          role: "user",
          content: `Recherche les derni√®res actualit√©s sur : ${searchQuery}. 

Fournis un r√©sum√© structur√© avec :
- Les 3-5 informations les plus importantes et r√©centes
- Dates pr√©cises si disponibles
- Sources fiables mentionn√©es
- Impact sur les agences immobili√®res
- Chiffres et statistiques r√©cents
- √âvolutions r√©glementaires ou de march√©

Format: texte structur√© avec d√©tails factuels et sources.`
        }
      ],
      temperature: 0.3,
      max_tokens: 2000
    }, {
      headers: {
        'Authorization': `Bearer ${PERPLEXITY_API_KEY}`,
        'Content-Type': 'application/json'
      }
    });

    const newsContent = response.data.choices[0]?.message?.content || '';
    console.log(`[PERPLEXITY] Success: ${newsContent.length} caract√®res d'actualit√©s`);
    
    return newsContent;
    
  } catch (error) {
    console.error('[PERPLEXITY] Erreur:', error);
    return 'Actualit√©s immobili√®res non disponibles. Contenu bas√© sur les tendances g√©n√©rales du secteur.';
  }
}

// FONCTION HYBRIDE - Perplexity + GPT-4 pour articles d'actualit√©
async function generateNewsArticle(newsTopic: any) {
  try {
    console.log(`[NEWS] G√©n√©ration article actualit√©: "${newsTopic.search}"`);
    
    // 1. Recherche actualit√© avec Perplexity
    const latestNews = await getLatestRealEstateNews(newsTopic.search);
    
    // 2. GPT-4 structure l'article avec les infos Perplexity
    if (!openai) {
      throw new Error('OpenAI not configured');
    }
    
    const hybridPrompt = `R√©dacteur actualit√© immobili√®re SEO. Article blog bas√© sur :

ACTUALIT√âS:
${latestNews}

MOTS-CL√âS: ${newsTopic.keywords.join(', ')}

STRUCTURE (1800-2200 mots):
1. **Titre** avec date 2025
2. <h2>üìà Introduction</h2><p> (150 mots) - Points cl√©s + Agenzys
3. **## Actualit√© d√©taill√©e** (400 mots) - Infos + dates
4. **## Impact agences** (400 mots) - Cons√©quences pratiques
5. **## Solutions Agenzys** (400 mots) - Adaptations
6. **## Analyse expert** (300 mots) - Recommandations
7. **## Conclusion** (200 mots) - CTA

STYLE: Journalistique expert, dates pr√©cises, CTA tous les 300 mots, liens https://agenzys.vercel.app

Format Markdown # ## ###.`;

    const articleResponse = await openai.chat.completions.create({
      model: "gpt-4",
      messages: [{
        role: "user",
        content: hybridPrompt
      }],
      temperature: 0.6,
      max_tokens: 7500,
    });

    const articleContent = String(await marked(articleResponse.choices[0]?.message?.content || ''));
    
    // 3. G√©n√©rer titre optimis√©
    const titleResponse = await openai.chat.completions.create({
      model: "gpt-4",
      messages: [{
        role: "user",
        content: `G√©n√®re un titre SEO parfait (50-60 caract√®res) pour cet article d'actualit√© immobili√®re bas√© sur : ${newsTopic.search}. 

Inclure mois/ann√©e 2025 et mot-cl√© principal : ${newsTopic.keywords[0]}`
      }],
      temperature: 0.7,
      max_tokens: 100,
    });

    const title = titleResponse.choices[0]?.message?.content?.replace(/"/g, '').trim() || newsTopic.search;

    return {
      title,
      content: articleContent,
      category: newsTopic.category,
      keywords: newsTopic.keywords,
      newsContent: latestNews,
      type: 'news'
    };
    
  } catch (error) {
    console.error('[NEWS] Erreur g√©n√©ration actualit√©:', error);
    throw error;
  }
}

// G√©n√©ration d'article avec OpenAI
async function generateArticleContent(topicData: any) {
  try {
    console.log(`[AI] G√©n√©ration GPT-4: "${topicData.title}"`);
    
    // V√©rifier si OpenAI est disponible
    if (!openai) {
      throw new Error('OpenAI not configured');
    }
    
    // 1. Contenu principal
    const contentResponse = await openai.chat.completions.create({
      model: "gpt-4",
      messages: [{
        role: "user",
        content: ARTICLE_PROMPT
          .replace('{topic}', topicData.title)
          .replace('{keywords}', topicData.keywords.join(', '))
      }],
      temperature: 0.7,
      max_tokens: 7500,
    });

    // GPT-4 g√©n√®re directement du HTML structur√©
    const content = contentResponse.choices[0]?.message?.content || '';

    // 2. Excerpt SEO
    const excerptResponse = await openai.chat.completions.create({
      model: "gpt-4",
      messages: [{
        role: "user",
        content: `G√©n√®re une meta description SEO (140-160 caract√®res) pour "${topicData.title}". Inclure le mot-cl√© principal et un CTA.`
      }],
      temperature: 0.6,
      max_tokens: 100,
    });

    const excerpt = excerptResponse.choices[0]?.message?.content?.replace(/"/g, '').trim() || '';

    // 3. Image DALL-E 3
    console.log(`[DALLE] G√©n√©ration image: "${topicData.title}"`);
    const imageResponse = await openai.images.generate({
      model: "dall-e-3",
      prompt: IMAGE_PROMPT.replace('{topic}', topicData.title),
      size: "1792x1024",
      quality: "standard",
      n: 1,
    });

    const imageUrl = imageResponse.data?.[0]?.url || '';

    // 4. Alt text SEO
    const altResponse = await openai.chat.completions.create({
      model: "gpt-4",
      messages: [{
        role: "user",
        content: `Alt text SEO (125 caract√®res max) pour image illustrant "${topicData.title}". Inclure mot-cl√©: ${topicData.keywords[0]}`
      }],
      temperature: 0.5,
      max_tokens: 50,
    });

    const imageAlt = altResponse.choices[0]?.message?.content?.replace(/"/g, '').trim() || topicData.title;

    console.log(`[AI] Article g√©n√©r√©: ${content?.length || 0} caract√®res`);

    return {
      title: topicData.title,
      excerpt,
      content,
      category: topicData.category,
      keywords: topicData.keywords,
      image: imageUrl,
      imageAlt,
      generation_method: 'GPT-4 + DALL-E',
      type: 'evergreen',
    };

  } catch (error) {
    console.error('[AI] Erreur OpenAI:', error);
    
    return {
      title: topicData.title,
      excerpt: `Guide complet sur ${topicData.title.toLowerCase()}. Strat√©gies √©prouv√©es et solutions Agenzys pour transformer votre agence immobili√®re.`,
      content: `# ${topicData.title}\n\n## Introduction\n\nArticle en cours de g√©n√©ration par notre IA. Contenu de qualit√© arrive bient√¥t !`,
      category: topicData.category,
      keywords: topicData.keywords,
      image: "https://images.unsplash.com/photo-1560518883-ce09059eeffa?ixlib=rb-4.0.3&auto=format&fit=crop&w=1200&q=80",
      imageAlt: `Illustration ${topicData.title}`,
      generation_method: 'Fallback - OpenAI unavailable',
      type: 'evergreen',
    };
  }
}

export async function POST(request: NextRequest) {
  try {
    const { topic, type = 'auto' } = await request.json().catch(() => ({}));

    let selectedTopic = topic;
    let articleData;
    
    if (!selectedTopic) {
      // SYST√àME INTELLIGENT: 70% evergreen, 30% actualit√©
      const useNews = Math.random() < 0.3;
      
      if (useNews) {
        // S√©lectionner sujet d'actualit√©
        selectedTopic = NEWS_TOPICS[Math.floor(Math.random() * NEWS_TOPICS.length)];
        console.log(`[NEWS] Sujet actualit√© s√©lectionn√©: "${selectedTopic.search}"`);
        
        // G√©n√©rer article hybride Perplexity + GPT-4
        const newsResult = await generateNewsArticle(selectedTopic);
        
        // G√©n√©rer excerpt et image comme d'habitude
        const excerpt = await generateExcerpt(newsResult.title);
        const { imageUrl, imageAlt } = await generateImageAndAlt(newsResult.title);
        
        articleData = {
          ...newsResult,
          excerpt,
          image: imageUrl,
          imageAlt,
          generation_method: 'Perplexity Sonar Pro + GPT-4'
        };
        
      } else {
        // S√©lectionner sujet evergreen classique
        selectedTopic = ARTICLE_TOPICS[Math.floor(Math.random() * ARTICLE_TOPICS.length)];
        console.log(`[AI] Sujet evergreen s√©lectionn√©: "${selectedTopic.title}"`);
        
        articleData = await generateArticleContent(selectedTopic);
      }
    } else {
      // Si sujet sp√©cifique fourni
      articleData = await generateArticleContent(selectedTopic);
    }

    return NextResponse.json({
      success: true,
      message: `Article g√©n√©r√© avec ${articleData.generation_method}`,
      article: articleData,
      seo_optimized: true,
      content_type: articleData.type || 'evergreen',
    });

  } catch (error) {
    console.error('[AI] Erreur g√©n√©ration:', error);
    return NextResponse.json({
      success: false,
      error: error instanceof Error ? error.message : String(error)
    }, { status: 500 });
  }
}

// Fonctions utilitaires pour r√©utiliser excerpt et image
async function generateExcerpt(title: string) {
  if (!openai) return `Guide complet sur ${title.toLowerCase()}. D√©couvrez les strat√©gies d'experts et solutions Agenzys.`;
  
  try {
    const excerptResponse = await openai.chat.completions.create({
      model: "gpt-4",
      messages: [{
        role: "user",
        content: `G√©n√®re une meta description SEO (140-160 caract√®res) pour "${title}". Inclure un CTA et le mot-cl√© principal.`
      }],
      temperature: 0.6,
      max_tokens: 100,
    });
    
    return excerptResponse.choices[0]?.message?.content?.replace(/"/g, '').trim() || '';
  } catch {
    return `Guide complet sur ${title.toLowerCase()}. Strat√©gies √©prouv√©es et solutions Agenzys.`;
  }
}

// FONCTION T√âL√âCHARGEMENT ET STOCKAGE D'IMAGE DALL-E
async function downloadAndStoreImage(imageUrl: string, filename: string): Promise<string> {
  try {
    console.log('[DOWNLOAD] T√©l√©chargement image DALL-E...');
    
    // T√©l√©charger l'image depuis DALL-E
    const response = await fetch(imageUrl);
    if (!response.ok) throw new Error(`HTTP ${response.status}`);
    
    const imageBuffer = await response.arrayBuffer();
    const uint8Array = new Uint8Array(imageBuffer);
    
    // Cr√©er le nom de fichier unique
    const timestamp = Date.now();
    const finalFilename = `${timestamp}-${filename.replace(/[^a-zA-Z0-9]/g, '-').toLowerCase()}.jpg`;
    
    // Pr√©parer les donn√©es pour GitHub
    const base64Content = Buffer.from(uint8Array).toString('base64');
    
    // Committer l'image sur GitHub dans public/images/blog/
    const githubResponse = await fetch(`https://api.github.com/repos/${process.env.GITHUB_REPO}/contents/public/images/blog/${finalFilename}`, {
      method: 'PUT',
      headers: {
        'Authorization': `Bearer ${process.env.GITHUB_TOKEN}`,
        'Content-Type': 'application/json',
      },
      body: JSON.stringify({
        message: `Add AI-generated blog image: ${finalFilename}`,
        content: base64Content,
        committer: {
          name: 'Agenzys AI',
          email: 'ai@agenzys.com'
        }
      })
    });

    if (!githubResponse.ok) {
      throw new Error(`GitHub API error: ${githubResponse.status}`);
    }

    const localImageUrl = `/images/blog/${finalFilename}`;
    console.log('[DOWNLOAD] Image sauvegard√©e:', localImageUrl);
    
    return localImageUrl;
    
  } catch (error) {
    console.error('[DOWNLOAD] Erreur t√©l√©chargement:', error);
    // Fallback : retourner l'URL originale si le t√©l√©chargement √©choue
    return imageUrl;
  }
}

async function generateImageAndAlt(title: string) {
  let imageUrl = "/images/blog/default-immobilier.jpg"; // Image par d√©faut locale
  let imageAlt = `Illustration professionnelle repr√©sentant ${title}`;
  
  if (!openai) return { imageUrl, imageAlt };
  
  try {
    console.log('[DALLE] G√©n√©ration image DALL-E...');
    
    // G√©n√©rer image DALL-E
    const imageResponse = await openai.images.generate({
      model: "dall-e-3",
      prompt: IMAGE_PROMPT.replace('{topic}', title),
      size: "1792x1024",
      quality: "standard",
      n: 1,
    });
    
    const dalleUrl = imageResponse.data?.[0]?.url;
    
    if (dalleUrl) {
      console.log('[DALLE] Image g√©n√©r√©e, t√©l√©chargement...');
      // T√©l√©charger et stocker l'image localement
      imageUrl = await downloadAndStoreImage(dalleUrl, title);
    }
    
    // G√©n√©rer alt text optimis√©
    const altResponse = await openai.chat.completions.create({
      model: "gpt-4",
      messages: [{
        role: "user",
        content: `Alt text SEO optimis√© (100 caract√®res max) pour "${title}". Inclure mots-cl√©s immobilier, technologie, innovation.`
      }],
      temperature: 0.5,
      max_tokens: 50,
    });
    
    imageAlt = altResponse.choices[0]?.message?.content?.replace(/"/g, '').trim() || imageAlt;
    
  } catch (error) {
    console.error('[DALLE] Erreur g√©n√©ration image:', error);
    // Garder l'image par d√©faut locale
  }
  
  return { imageUrl, imageAlt };
}